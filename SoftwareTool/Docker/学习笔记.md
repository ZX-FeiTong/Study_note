# Docker 学习笔记

这篇学习笔记将用于记录本人在学习 Docker 服务端运维工具过程中所记录的学习心得，它将会被存储在`https://github.com/owlman/study_note`项目的`SoftwareTool`目录下一个名为的`Docker`目录中。

## 学习规划

- 学习基础：
  - 有一两门编程语言的使用经验。
  - 有一定的 Web 开发及维护经验。
- 视频资料：
  - [黑马程序员 Docker 容器化技术](https://www.bilibili.com/video/BV1CJ411T7BK)：哔哩哔哩上的视频教程。
- 阅读资料：
  - [《深入浅出 Docker》](https://book.douban.com/subject/30486354/)：本人学习所用书籍。
- 学习目标：
  - 使用 Docker 发布并维护自己的私人项目.

## Docker 简介

和许多成功的软件项目都有一个无心插柳柳成荫的故事一样，Docker 原本只是一家名为 dotCloud 的 PaaS 服务提供商启动的一个业余项目，该项目在开源之后意外获得了巨大的成功，以至于 dotCloud 公司干脆放弃了原本就不景气的 PaaS 业务，并且将公司改名为 Docker Inc，以便专职维护这个项目。该项目如今的正式名称叫 Moby，读者可以在 GitHub 上找到它。

Docker 这个词在英文中的意思是“码头工人”，这一工种的主要工作是装卸货船上的集装箱，因此该运维工具的核心工作理念就是让应用程序在服务器上的部署像装卸集装箱一样，实现标准化的组件式管理，业界称这种工作理念为容器化部署。从概念上来看，容器的概念和传统的虚拟机比较类似，它们之间主要存在着以下区别：

- 虚拟机依赖的是计算机硬件层面上的技术，而容器是构建在操作系统层面上的，它复用的是操作系统的容器化技术。
- 虚拟机中部署的是一个完整的操作系统，而容器中封装的只是一个与指定应用程序相关的操作系统子集，相对更为轻量化。
- 虚拟机通常是通过快照来保存其运行状态的；而容器则引入了类似于版本控制系统的机制，这种机制可以让运维人员更方便、快速地将应用程序的运行状态切换到其之前的某个历史时间节点上。

以上不同之处也解释了我们为什么需要使用 Docker 这样的工具来对服务端的应用程序进行容器化部署。试想一下，如果我们基于 Vue.js 前端框架、Express.js 后端框架以及 MongoDB 数据库开发了一个 Web 应用程序，而这些应用程序框架和数据库的版本通常是日新月异，不同版本之间内部实现的变化有时也非常剧烈，很多时候基于前一个版本可用的代码，到了下一个版本就运行出错了。这就要求我们在最终部署应用程序的时候在服务器上安装指定版本的框架和数据库，这将是一个非常耗时费力且容易出错的工作。而且一旦遇到服务器故障，应用迁移等问题，这一切工作又得重来一遍，其运维成本可想而知。而容器的作用就是能将应用程序与其所依赖的框架、数据库、操作系统固化下来。

Docker 本质上就是这样一个基于Linux容器（Linux Containers，简称 LXC）技术实现的容器管理引擎。它会通过应用程序及所有程序的依赖环境打包到一个虚拟容器中，这个虚拟容器可以运行在任何一台安装了 Docker 容器引擎的服务器设备上，无论该设备是一台实体的物理设备、还是无实体的云主机或本地虚拟机，都不会影响我们部署容器内的应用程序。这样一来，我们就可以在任何主流的操作系统中对服务端的应用程序进行开发、调试和运行，而不必担心它的可移植性了。

## 安装 Docker

在正式安装 Docker 之前，我们首先要了解一下该产品所发布的各种版本。和所有追求盈利的软件公司一样，随着产品在市场上的不断流行与发展，docker Inc 公司也不能免俗地开启了将产品商业化的道路。于是，Docker 自 17.03 这个版本之后就被分成了 CE（Community Edition，即社区版）和 EE（Enterprise Edition，即企业版）两种不同的版本。其中，Docker CE 是保持免费的版本，它包含了完整的 Docker 平台，非常适合开发人员和运维团队构建用于部署指定应用程序的容器。值得一提的是，Docker CE 本身也还被分成了以下两个版本：

- edge 版本每月发布一次，只提供一个月的支持和维护期，主要面向那些热衷于研究 Docker 本身，喜欢尝试新功能的用户。
- stable 版本每季度发布一次，将提供四个月的支持和维护期，适用于希望在具体工作中对一些实际项目进行维护的用户。

而 Docker EE 的发布节奏则与 Docker CE 的 stable 版本基本保持一致，但每个 Docker EE 版本都享受为期一年的支持与维护期，在此期间接受安全与关键修正。总而言之，Docker CE 并非是功能上的阉割版，而 Docker EE 则只是面前企业用户增加了收费的维护服务以及一些周边产品，以求进一步降低企业运营的风险，但它们在个人的学习体验上不会有太大的区别。

在这本书中，我们将会主要以 Docker CE 为主来展开针对容器化部署议题的探讨，因此接下来的任务就是要在一个之前配置好的 Ubuntu 系统中安装 Docker CE。为此，我们需要执行以下步骤。

- 首先要做的是将 Docker 所在的 APT 软件源添加到 Ubuntu 的 APT 列表中，为此，我们需要先更新一下当前的软件包索引，并安装一些基础工具：

    ```bash
    sudo apt update
    sudo apt install \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg \
        lsb-release
    ```

- 接下来，我们需要使用 curl 工具导入 Docker APT 软件源的 GPG 密钥：

    ```bash
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    ```

- 现在，我们就可以通过以下命令正式地将 Docker APT 软件源添加到 Ubuntu 的 APT 列表中：

    ```bash
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    # `sb_release -cs`变量表达式返回的是Ubuntu的版本代号，在这里是focal。
    ```

- 最后，我们需要再次更新一下系统的软件包索引，然后就可以安装 Docker CE 了，其安装命令如下：

    ```bash
    sudo apt update
    sudo apt install \
       docker-ce \
       docker-ce-cli \
       containerd.io
    ```

当然了，以上命令安装的是 Docker APT 软件源中的最新版本，如果我们想安装的是 Docker 的某个指定版本，需要先执行`apt list -a docker-ce`命令获取到 Docker APT 软件源中所有可用的版本，例如像这样：

```bash
$ apt list -a docker-ce
Listing...
docker-ce/focal,now 5:20.10.12~3-0~ubuntu-focal amd64 [installed]
docker-ce/focal 5:20.10.11~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.10~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.9~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.8~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.7~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.6~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.5~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.4~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.3~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.2~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.1~3-0~ubuntu-focal amd64
docker-ce/focal 5:20.10.0~3-0~ubuntu-focal amd64
docker-ce/focal 5:19.03.15~3-0~ubuntu-focal amd64
docker-ce/focal 5:19.03.14~3-0~ubuntu-focal amd64
docker-ce/focal 5:19.03.13~3-0~ubuntu-focal amd64
docker-ce/focal 5:19.03.12~3-0~ubuntu-focal amd64
docker-ce/focal 5:19.03.11~3-0~ubuntu-focal amd64
docker-ce/focal 5:19.03.10~3-0~ubuntu-focal amd64
docker-ce/focal 5:19.03.9~3-0~ubuntu-focal amd64
```

然后根据该命令列出的可用版本，执行以下命令来安装：

```bash
# 通过在软件包名后面添加""=<版本号>"的方式来安装指定版本：
sudo apt install \
    docker-ce=<版本号> \
    docker-ce-cli=<版本号> \
    containerd.io
```

使用APT软件源来安装软件的另一个好处是，当新版本的 Docker CE 发布时，我们可以直接通过`sudo apt update && sudo apt upgrade`命令来进行自动升级。当然了，如果想阻止 Docker 的自动更新，我们也可以通过执行以下命令来锁住它的版本：

```bash
sudo apt-mark hold docker-ce
```

## 配置工作

在基于 Debian 项目的 Linux 发行版上，docker在被安装只会通常会被自动设置为系统的开机启动服务。当然了，如果需要的话，我们也可以通过执行以下命令手动该服务设置为系统的开机启动项。

```bash
sudo systemctl enable docker
```

在一切安装妥当之后，我们可以通过以下这命令来查看 Docker 的版本并确认该服务是否已被启动：

```bash
$ docker version
 Client: Docker Engine - Community
 Version:           20.10.12
 API version:       1.41
 Go version:        go1.16.12
 Git commit:        e91ed57
 Built:             Mon Dec 13 11:45:33 2021
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      true
$ sudo service docker status
 * Docker is running
```

另外，由于在默认情况下，只有`root`用户或有`sudo`权限的用户可以执行Docker操作，所以如果我们平时使用非`root`用户，但又不想每次执行Docker操作的时候都得在相关命令之前加上`sudo`前缀，也可以选择添加一个`docker`用户组，并将我们使用的非root用户加入到该组中，其具体命令如下：

```bash
sudo groupadd docker
sudo usermod -aG docker $USER
# 这里的$USER是一个环境变量，代表当前用户名。
```

如果我们想要确认一下 Docker 的容器管理功能是否已经可供使用，可以试着执行以下命令运行一个测试容器：

```bash
docker container run hello-world
```

上述命令将会从 Docker Hub 中下载一个名为`hello-world`测试镜像，并根据该镜像实例化一个测试容器。而该容器中的应用程序会在运行时打印出带有“Hello from Docker”字样等相关内容的信息之后退出。

## 镜像操作

docker image pull是下载镜像的命令。镜像从远程镜像仓库服务的仓库中下载。默认情况下，镜像会从Docker Hub的仓库中拉取。docker image pull alpine:latest命令会从DockerHub的alpine仓库中拉取标签为latest的镜像。

docker image ls列出了本地Docker主机上存储的镜像。可以通过--digests参数来查看镜像的SHA256签名。

docker image inspect命令非常有用！该命令完美展示了镜像的细节，包括镜像层数据和元数据。

docker image rm用于删除镜像。docker image rmalpine:latest命令的含义是删除alpine:latest镜像。当镜像存在关联的容器，并且容器处于运行（Up）或者停止（Exited）状态时，不允许删除该镜像。

## 容器操作

## 数据共享

