# Rust 学习笔记（持续更新中）

这篇学习笔记将用于记录本人在学习 Rust 编程语言过程中所编写的学习心得与代码。为此，我会在`https://github.com/owlman/study_note`项目的`Programming/LanguageStudy/`目录下创建一个名为的`Rust`目录，并在该目录下设置以下两个子目录：

- `QuickStart`目录用于存放 Markdown 格式的笔记。
- `Examples`目录则用于存放笔记中所记录的代码示例。

## 学习资料

- 参考书籍：
  - [《精通 Rust》](https://book.douban.com/subject/35290878/)：本人所采用的主要参考书；
  - [《Rust 实战》](https://book.douban.com/subject/36059499/)：本人所采用的补充参考书；
- 视频教程：
  - [Rust 编程语言入门教程](https://www.bilibili.com/video/BV1hp4y1k7SV?spm_id_from=333.999.0.0)：哔哩哔哩上的教学视频；

## 学习准备阶段

Rust 是一门由 Mozilla 基金会主导开发的通用、编译型程序设计语言。这门语言的设计准则为“安全、并发、实用”，支持函数式、并发式、命令式等多种编程范式，目前被认为是自 C++ 以来最全能的系统级程序设计语言。它为系统编程领域提供了一种更安全、更快速且原生支持并发的现代化解决方案，因而具有相当的学习价值。当然了，按照学习一门编程语言的惯例，在进入具体的学习阶段之前，我们需要做一些准备工作。首先，让我们来了解一下该语言的起源故事，以便之后的学习过程中更好地理解它的设计思想。

### 语言的起源故事

[Rust 项目](https://github.com/rust-lang/rust) 最初是 Mozilla 公司员工、主要负责编译器实现的语言工程师 Graydon Hoare 在 2006 年开发的一个私人试验项目。众所周知，在上个世纪 70 年代末和 80 年代初，编程语言领域出现了许多优秀的设计理念，但这些理念中的许多设计都受限于当时的技术条件，并没有机会被转化成得到广泛使用的系统级语言，Graydon Hoare 希望能在该项目中通过结合现代编程语言的相关理论来重新设计一门系统级编程语言，目标是让开发者们在系统编程领域中能在得到比 C/C++更好的编码体验的同时，避开 Java/C# 这类语言因其自身附带的大型垃圾回收机制而产生的内存开销。关于这方面的详细信息，读者可参考[InfoQ 在 2012 年对 Graydon Hoare 本人的专访](https://www.infoq.com/news/2012/08/Interview-Rust/)。至于 Mozilla 基金会本身则是从 2009 年开始赞助这个项目的。他们成立了专门的团队来支持 Rust 的开发，并开始将其应用于实验性的 Servo 浏览器引擎项目。

2010 年之后，Rust 项目正式向公众发布，同年开始改写自托管编译器（基于 LLVM 后端）来替换原来用 OCaml 写的编译器。其发布方式主要分为 stable、beta、nightly 三个版本系列。其中，nightly 版本系列会每天迭代一次，主要用于开发者针对 Rust 语言的最新特性进行学习和研究。而 beta 版本系列则是针对一些相对成熟的特性发布的测试版本，每六周迭代一次，通常用于前瞻性的试验性开发。然后，beta 系列的版本在通过了六周的测试之后，就会被合并到 stable 版本系列中，后者是主要用于实际生产环境的稳定版本。基本上，Rust 项目的发布流程就像火车一样按照时刻表井然有序。

```bash
nightly: * - - * - - * - - * - - * - - * - * - *
                     |                         |
beta:                * - - - - - - - - *       *
                                       |
stable:                                *
```

Stack Overflow 的开发者调研显示只有 7% 的开发者在使用 Rust，对比 JavaScript、Python 等语言，使用 Rust 的开发者占比并不高；但从 2016 年开始，Rust 每年都是开发者最爱的编程语言 [9]。

# 最爱的特性 #
首先 Rust 是存在一些不足的，比如学习曲线陡峭，在 2020 年的调研中约 15.8% 的开发者认为如果 Rust 更好学那么应用 Rust 的人会更多，而完善文档和课程是提及最多的方法。Rust 语言概念层次结构如下图 [10]：


Rust 语言概念层次结构梳理[10]
其中生命周期、所有权等概念对于初学者来说可能难以理解，特别是“生命周期”，有 61.4% 的反馈者认为难以理解或学习困难 [11]；


Rust 中最难的话题[11]
另外编译时间较长也是 Rust 社区一直在讨论的问题，在 2020 年的调研中约半数开发者（50.5%）感觉已经有一定的提升，但缩短 Rust 的编译时间仍然是 Rust 团队接下来的重要任务 [11]。

不过这些不足完全不能掩盖 Rust 的突出优势。

Rust 设计的目标人群是“被 C++ 所困扰的开发者”。C/C++ 一直是系统编程的首选，但由于内存安全、数据竞争等引起的问题也一直存在，Rust 就是为了从语言层面解决这些问题而诞生的。

在实现安全系统编程的同时对底层有控制权 [12]，官网介绍 Rust 可以“赋予每个人构建可靠高效的软件的能力” [13]。

高性能 [13]：Rust 没有运行时和垃圾回收器，可以提供对性能要求很高的服务，可在嵌入式设备上运行，也可以很方便地和其他语言集成 [13]；对比 C、C++ 和 Go，可以看到 Rust 的性能和 C++ 接近，远快于 Go [14]。

Rust vs C gcc/Clang [14]

Rust vs C++/Go [14]
2. 可靠性 [13]：安全可以说是 Rust 对比 C 语言最大的优势 [2]，2020 年 8 月 Rarf Jung 在他的博士论文中提供了第一个正式证据（RustBelt），证明了 Rust 的安全承诺成立 [15]，即使开发者有可能编写“不安全”代码，Rust 的安全声明仍然有效 [16]。

内存安全：采用了所有权类型系统，每个被分配的内存都有指针，且给每个变量都设定了生命周期，一旦超出生命周期，变量就会被自动释放 [12]；划分安全边界，如果你要做内存不安全的事情，必须在代码中明确 [2]；
线程安全：采用 1:1 线程模型，不需要运行时，消除了数据竞争现象。
3. 生产力 [13]：

提供全面出色的文档，由专门的社区团队维护；
支持多编辑器的智能自动补全、类型监测和自动格式化代码等功能；
清晰的错误提示；
包管理和构建工具。

# 开源生态 #

# 开源运营

Rust 在 2009 年开源，虽然是由 Mozilla 资助，但其实是一个社区共有的项目，很大一部分代码来自于社区贡献者 [1]。从 Rust 0.1.0 开始，共有 6273 人参与 Rust 社区贡献（数据来自 GitHub 上 rust-lang/rust 仓库和大部分相关子模块）[7]，各版本的贡献者和贡献数如下图，除了最初的 0.1.0 版本，2017 年 4 月发布的 1.17.0 版本贡献者数和贡献数最多。


Rust 社区贡献[7]
Rust 有完善的提案流程（RFC，Request For Comments），每一个人都可以提交提案，进行开发工作的核心团队细分为专项治理语言项目、社区运营、语言核心开发、工具开发、库开发等，来管理维护各个项目的各方面事项，具体如下图 [13]：


Rust 团队[13]
语言在不同领域的应用则由工作组来开发维护，如嵌入式设备、游戏开发、安全响应等 [13]。


Rust 工作组[13]
除了工作团队和工作组，还提供了用户论坛（讨论任何与 Rust 相关的内容）、内部论坛（讨论语言自身开发）和 Discord、Zulip 等聊天平台用来交流 [13]。

日常有超过 90 个聚会和几个世界级的会议，对 Rust 感兴趣的开发者可以注册自己的活动，社区团队也提供了一些活动支持 [17]，并运营了 RustBridge 项目帮助开发者学习 Rust。

受疫情影响，Mozilla 在 2020 年 8 月宣布裁员约 250 人，占了公司人数的四分之一，其中包括了 Rust 开发团队。

虽然 Mozilla 被砍的项目非常令人惋惜，但Rust 开发团队的专家们被裁后加入了 Facebook、Amazon、Google 等科技巨头公司 [4]，也许 Rust 会因此变得更加开放、获得更多资源支持。2021 年 2 月 Rust 基金会宣布成立，赞助商包括了华为、AWS、Google、Microsoft、Facebook 等，基金会将会完全专注于 Rust 语言的开发与生态发展 [18]。


Rust 基金会成员[18]
# 包管理

Rust 共有 6.8 万个注册的包，包括基础库和框架，总下载次数达到 95 亿次，下载次数较多的包涉及数值、解析器、字符解码、FFi 开发、序列化/反序列化等，其中下载次数最多的“rand”库（2015 年 2 月首次提交），下载次数已超过 8000 万 [19]；第二的“syn”库为 Rust 源码解析器（2019 年 6 月首次提交），下载次数已有 7500 多万。


下载次数最多的库[19]
包数量最多的分类是如下，除了通用的命令行程序、无标准库运行、开发工具等，可以看到 Web 编程、网络编程、数据结构、密码学、嵌入式开发、异步相关的库也比较多。


库数量最多的分类[19]
# 商业应用 #
2015 年 Rust 才发布稳定版本，但已有很多大公司选择 Rust 来开发或改写重要项目 [20]：

Parity：安全的语言特性与区块链的特性天生有重合性，因此区块链也成为较早引入 Rust 语言的领域之一，Gavin Wood 博士开发的 Parity 客户端应该是首个使用 Rust 的区块链项目，于 2015 年推出，Parity Technologies 的产品还包括 Polkadot、substrate 等 [3]。
Facebook: 从 2016 年开始使用 Rust，当时启动了一个名为 Mononoke 的重写项目；有 Mononoke 项目作为 Rust 语言是可行的，2019 年内部 Rust 开发团队达到了 100 人，并开始应用于 Diem 区块链项目；2020 年在内部成立了 Rust 开发者体验团队，继续为 Rust 社区做贡献，并支持内部 Rust 项目开发 [21]。
Google：2016 年开始开发的 Fuchsia 操作系统，在 2020 年 12 月首次亮相于 google open source [22]，其中 22% 的代码为 Rust 编写 [23]。
Amazon：从 2017 年开始在一些服务中使用 Rust，如 Firecracker（2018 年）、Botterocket（2021 年）等 [24]。
微软：2019 年 2 月发布报告称 70% 的安全问题为内存安全问题，为了解决安全问题，开始尝试使用 Rust 来代替 C/C++ 重写 Windows 组件；微软的 DeisLabs 团队也选择 Rust 来构建 Kubernetes 工具 Krustlet，并称 Rust 比 Go 更适合 Kubernetes 的开发 [25]。
2020 年 12 月，首届 RustChinaConf 在深圳举办，由 Rust 语言中文社区主导，赞助商包括华为、飞书、solana、NEAR 等企业，会议议题涉及区块链、数据库、云计算等各个领域，国内企业在 Rust 应用项目上也已有一定的尝试 [20]：

PingCAP：于 2016 年 1 月开始使用 Rust 开发底层分布式储存 TIKV，并于 2016 年 4 月开源 [26]。
字节跳动飞书团队：2017 年开始引入 Rust，飞书客户端非 UI 部分是由 Rust 跨平台实现 [27]；2021 年 5 月开源 rsmpeg 项目，一个 FFmpeg 的库，也是采用 Rust 作为主要语言 [28]。
华为：华为致力于推进通信系统软件的安全可信演进，一直活跃于 Rust 社区，开发了代发度量工具 Tokei、Cargo-Geiger 等；同时也尝试将 Rust 应用于开源项目，StratoVirt 是 openEuler 上的企业级虚拟化平台，面向云数据中心，实现了一套架构统一支持虚拟机、容器、Serverless 三种场景 [29]；MindSpore 的 AI 团队建立了基于 TVM Rust Runtime 的运行模型，并发起了 Rusted AI 的非商业组织，推动 Rust 在 AI 领域的应用落地 [30]。
安全问题是商业公司考虑采用 Rust 的首要原因，Rust 在没有牺牲性能的情况下提供了比 C/C++ 安全的系统编程，使其成为了更好的选择。

但根据 JetBrains 2021 年的调研报告，出于兴趣或为私人项目选择 Rust 的开发者仍然占大多数，真正用于工作的开发者仅占 16%，而 Go 语言用于工作的开发者比例占到了 61%，差距明显 [31]。为 Rust 项目提供支持、给 Rust 开发者创造更多工作机会也是 Rust 基金会的目标之一。


Rust 应用[31]
# 总结 #
Rust 的设计哲学是内存安全、零成本抽象和实用性 [10]，其解决的安全问题是系统开发一直以来的痛点，传统领域如网络、数据库对于安全要求越来越高，新兴领域如区块链天然对于安全性就有极高的要求，因此 Rust 才能迅速获得国内外公司的青睐，成为 C/C++ 的有力竞争者。

除了性能上的核心竞争点，Rust 开源开发和生态建设的团队工作也非常明确。Rust 基金会成立后，整体项目由基金会来支持；开发通过开源社区进行；且由于 Rust 语言的学习门槛，社区团队在尽可能完善文档，帮助更多的人成为专业的 Rust 开发者，也吸引到了大量专业人士积极参与贡献。

Rust 名字来源于一种生命力很强的真菌，Graydon Hoare 希望 Rust 语言可以覆盖在死去语言的残骸之上，吸收这些旧语言的优秀特性，像真菌一样拥有多种可以互相转化的生命形态 [32]。Rust 的名字从字形上糅合了 Trust 和 Robust，也暗示了“信任”和“鲁棒性” [10]。目前来看，Rust 确实拥有了极强的生命力，让我们期待一下 Rust 的永不休眠。

在 1.0 稳定版之前，语言设计也因为透过撰写 Servo 网页浏览器排版引擎和 rustc 编译器本身，而有进一步的改善。虽然它由 Mozilla 资助，但它其实是一个开源项目，有很大部分的代码是来自于社区的贡献者。

### 语言的优势分析

Rust 语言的设计目标是希望帮助人们以更简单明了的方式来设计高度可靠且快速的软件系统，它既可用于底层机器操作的具体实现，也可用于高层抽象逻辑的应用设计，因此成为了时下最热门的程序设计语言之一。具体来说，Rust 语言相较于其他程序设计语言具有以下独特优势：

- **更安全的内存管理**：与 C/C++ 语言相比，使用 Rust 语言来进行程序设计可以从源头上去预防出现诸如空指针，缓存溢出和内存泄漏等问题带来的困扰。
- **更好的运行性能**：与 Java/C# 等语言相比，Rust 语言的内存管理不是依靠垃圾回收器机制（ GC ）来实现的。这个设计提高了程序运行的性能。
- **原生支持多线程开发**：Rust 语言的所有权机制和内存安全的特性为没有数据竞争的并发提供了语言层面上的原生支持。
- **支持 WebAssembly**：WebAssembly 语言的出现解决了人们希望在 Web 浏览器、嵌入式设备等环境中执行计算密集型操作的需求。而用 Rust 语言编写的代码可以被直接编译成 WebAssembly 程序，这样就能确保程序在上述执行环境中拥有与本地代码相似的执行速度。

下面来看一看 Rust 语言的主要使用场景：

- **学术研究**：Rust 语言在计算机专业领域中是一个很好的学术研究工具。例如，人们可以学习如何使用 Rust 语言开发操作系统，这个学习过程将帮助他们更好地理解操作系统中的各种概念。
- **团队合作**：对于开发者团队来说， Rust 语言是非常实用的工具。众所周知，低水平的程序代码会包含很多 bug，需要测试人员进行覆盖测试广泛验证。然而在 Rust 语言中，如果程序代码中包含 bug，编译器将拒绝编译代码，这样一来，开发者就可以更专注于程序的业务逻辑了。
- **商业开发**：到目前为止，已经有不少大大小小的公司选择使用 Rust 语言来完成各种商业开发的任务。这些任务包括命令行工具，Web 服务，DevOps 工具，嵌入式设备，音频和视频的分析和转码，加密货币，生物信息学，搜索引擎，物联网应用，机器学习，甚至是火狐浏览器的重要组成部分。
- **开源运动**：Rust 本身就是一门遵守 Apache 和 MIT 开源许可证的程序设计语言，这意味人们可以按照这些许可证赋予的权益参与各种 Rust 语言设计与推广的公益活动。

### 语言环境的配置

由于 Rust 的语言环境是基于 C/C++ 编译工具来构建的，这意味着在安装语言环境之前，我们的计算机上至少需要先安装一个 C/C++ 编译工具。换句话说，如果该计算机上使用的是类 Linux 系统，它就需要先安装 GCC 或 clang。如果是 macOS 系统，则就需要先安装 Xcode。如果是 Windows，则需要先安装 Visual Studio 2013 或 MinGW 之类的 C/C++ 编译工具。

#### 下载并执行安装脚本

到目前为止，Rust 语言环境大体上都是通过安装脚本的形式来安装的。所以在确定安装了 C/C++ 编译工具之后，` 接下来要做的就是根据自己所在的操作系统来下载并执行 Rust 语言环境的安装脚本了。

- 如果想要在 Windows 系统下学习 Rust，我们只需在搜索引擎中搜索“rust”关键字或直接在 Web 浏览器的地址栏中输入`https://www.rust-lang.org/`这个 URL 即可进入到 Rust 语言的官方网站，然后通过点击首页中的“install”链接，就会看到如下页面：

  ![rust_install](img/rust_install.png)

  在该页面中，我们可以根据自己所在的平台来下载 32 位或 64 位版本的安装脚本（通常是一个名为`rustup-init.exe`的二进制文件）。待下载完成之后，我们就可以双击执行该安装脚本，并遵循屏幕上的指示来安装（对于初学者，只需一路选择默认选项即可）。

- 如果想在类 UNIX 系统（包括 WSL 环境)下学习 Rust，我们只需直接终端环境中执行下面的 shell 代码，并遵循终端返回的指示信息来安装（对于初学者，只需一路选择默认选项即可）。

  ```bash
  # 可选步骤：设置国内下载镜像
  echo "export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static" >> ~/.bashrc
  echo "export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup" >> ~/.bashrc
  source .bashrc

  # 下载并执行安装脚本
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

  # 安装完毕后刷新环境变量
  source ~/.cargo/env
  ```

#### 管理语言环境的版本

默认情况下，我们安装的语言环境是属于 stable 这一版本系列的，这一系列的版本迭代周期大约是每六周一次，它在各方面的配备都会偏向于确保生产环境的稳定性。但如果我们想使用类似 racer 这一类组件的部分功能，就必须切换到配置方案更偏向于学习、实验性质的 nightly 版本（这一系列的版本迭代周期是每天一次）。在 Rust 语言环境中，版本管理通常是利用 rustup 这一命令行工具来完成的，其具体使用方式如下：

```bash
# rustup install <版本号> 或 <版本系列名称>
# 如果想安装 1.68.0 版本的 Rust 语言环境，可执行命令：
rustup install 1.68.0
# 如果想安装语言环境的 nightly 系列中的最新版本，可执行命令：
rustup install nightly
# 如果想设置语言环境的默认版本，可执行命令：
rustup default nightly
# 如果想更新当前语言环境的版本，可执行命令：
rustup update
# 如果想删除当前版本的语言环境，可执行命令：
rustup self uninstall
```

待成功执行语言环境的安装操作之后，我们可通过在终端中执行`rustc -V` 和`cargo -V`来验证安装是否查看是否能输出相应的版本信息。如果这两个命令输出了相应的版本信息，就证明 Rust 语言环境的安装和配置工作已经成功了一半了，接下来的任务是配置 Cargo 并安装相关插件。

#### 使用 Cargo 包管理器

Cargo 是一个内置在 Rust 语言环境中的包管理器及项目构建工具，其作用类似于 Node.js 运行环境中的 NPM。也就是说，在开发 Rust 项目的过程中，我们可以使用 Cargo 包管理器来下载并管理当前项目所依赖的第三方程序库，以及完成项目的构建工作。

和 NPM 一样，Cargo 在默认情况下链接的是`https://crates.io/`这个官方的程序仓库。由于众所周知的原因，这个服务器位于国外的官方仓库的可用性非常容易受到各种不可抗力的影响，很多时候是不确定的，我们最好还是将其设置为国内的代理仓库。为此，我们需要将代理仓库的服务器地址写到 cargo 的配置文件中（该配置文件就叫“config”，没有扩展名，通常情况下位于`${HOME}/.cargo/`目录中）。在这里，我将其具体配置如下：

```bash
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
# 指定镜像
replace-with = 'sjtu'

# 清华大学
[source.tuna]
registry = "https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git"

# 中国科学技术大学
[source.ustc]
registry = "git://mirrors.ustc.edu.cn/crates.io-index"

# 上海交通大学
[source.sjtu]
registry = "https://mirrors.sjtug.sjtu.edu.cn/git/crates.io-index"

# rustcc 社区
[source.rustcc]
registry = "https://code.aliyun.com/rustcc/crates.io-index.git"
```

在配置完上述内容之后，可以通过执行`rustup update`命令来验证代理仓库是否可用。如果一切正常，该命令会将当前语言环境中的所有组件更新到最新版本。

安装 rust-analyzer 组件

```bash
rustup component add rust-analyzer --toolchain stable
```

#### 构建开发环境

推荐使用 VSCode：`https://code.visualstudio.com/`
安装好 VSCode后，Ctrl + Shift + X 打开应用商店
搜索chinese安装中文语言包，搜索Rust (rls)官方的插件，基本上就OK可以撸代码了。

## 语言基础学习阶段

### 使用 Cargo 构建并运行项目

## 第 2 部分：编写本地应用程序

## 第 3 部分：编写网络应用程序
