# 关于 Windows 系统的学习及其推荐书目

众所周知，在我们日常工作和生活中所接触到的个人计算机中，除了少数人使用的以 macOS 为操作系统的 Mac 系列设备之外，大部分人使用的都是以 Windows 为主要操作系统的 IBM PC。因此，如果你是一个面向中国市场的程序员，学习和研究基于 Windows 系统来开发设备驱动和应用程序将是一个绕不过去的课题。而想要在这一领域获得可长可久的生产力，我们自然需要深入地 Windows 系统本身的各种运行机制和设计思想。在本文接下来的内容中，我们将会以推荐书目的形式来为读者规划一个研究 Windows 系统内核及其应用层开发的学习路线图，以供参考。

## Windows 内部机制研究

如果按照操作系统内核类来进行分类，Windows 系统发展到目前为止，主要可被分为 MS-DOS 和 Windows NT 两个系列。其中，采用 MS-DOS 内核的主要包括 Windows 95/98/Me 这一系列操作系统，它们的共同特点是需要基于 16 位的 MS-DOS 基层程序来运行，并不能被视为真正意义上的 32 位操作系统。这主要是因为 Windows 最初是作为 MS-DOS 系统的图形界面被开发出来的，其地位相当于类 UNIX 系统中的 GNOME 和 KDE，本质上属于操作系统的 Shell。当然了，由于采用该内核的 Windows 系统已经年代久远，如今已经鲜少有人研究了，读者只需粗略了解一下即可。

自 Windows 2000 之后，所有版本的 Windows 系统都转而采用了原本只专用于服务器领域的 Windows NT 内核。由于该内核的实现彻底摆脱了对 DOS 基础程序的依赖，因而提供了比 MS-DOS 内核更好的执行性能、稳定性以及用户体验。虽然 Windows 是一个不开放源代码的操作系统，我们在面向该系统进行设备驱动与应用程序开发时未必需要了解它的内部实现，但在笔者看来，适当了解一下 Windows 的内核实现，将有助于理解为什么 Windows 系统的图形界面相较于类 UNIX 系统更有优势，并提高在工作中查找其浩如烟海的 API 时的效率和方向感。关于这方面的知识，读者可以去阅读一下潘爱民老师的《Windows 内核原理与实现》，这本书将以以 Windows 的源代码（WRK, Windows Research Kernel）为参照，详细解析 Windows 如何实现现代操作系统的各个关键部件，其中包括了进程、线程、物理内存和虚拟内存的管理，Windows 中的同步和并发性支持，以及Windows 的 I/O 模型等重要的议题。

![《Windows 内核原理与实现》](./img/1-1.jpg)

当然了，如果读者不想通过内核实现的角度来了解 Windows 系统的内部运行机制，也可以选择阅读由 Microsoft 公司亲自组织编著和出版的“Microsoft Windows Internals”系列作品，目前最新为第 7 版。下面，我们通过简单回顾一下该系列作品的版本迭代史，来帮助读者理解一下它在 Windows 领域的重要性。

- 该系列作品的第一个版本由 Windows NT 内核之父 Helen Custer 亲自编写，书名“Inside Windows NT”。

- 作品的第二个版本改由 David Solomon 编写，这位 David Solomon 是 David Cutler 在 DEC 任职就相识的老伙伴。因而被 David Cutler 特许自由翻看 Windows NT 内核的源代码。

- 作品的第三个版本的书名改成 “Inside Windows 2000”，由 David Solomon 和 Mark Russinovich 共同编写。

- 到了第四个版本之后，该作品的书名就基本固定为 “Microsoft Windows Internals”了，中文译为《深入解析 Windows 操作系统》。

所以显而易见的，该系列作品无疑是 Windows 领域作为权威的一本著作之一，虽然没有提供操作系统的内核源代码，，但我们确实可以相信这本书可以让读者做到知其然并且知其所以然。当然了，对于这个系列的作品，如今大部分读者只需要读过其第 4 版之后的任何一个版本即可，其最基本的内容是大同小异的。例如，我个人读过的是它的第 4 版。

![《深入解析 Windows 操作系统》](./img/1-2.jpg)

<!-- 以下为参考资料 -->


第二本书是Walter Oney的 “Programming the Microsoft Windows Driver Model”第2版，微软出版社2003年版。这本书对微软的 WDM设备驱动模型(即框架)作了深入的介绍。微软要求从Win2k开始的设备驱动模块都符合WDM的要求。与传统的Windows NT设备驱动相比，WDM要求设备驱动模块都支持PnP(即插即用)、电源管理(不用时可转入省电模式)、以及WMI (Windows Management Instrumentation，意为Windows管理手段，是微软版的WBEM实现)。所以，这本书所介绍的是新的Window设备驱动框架的设计与实现，附带着也介绍了设备驱动界面上的一些重要的函数。显然，这本书对于兼容内核中设备驱动框架和设备驱动界面的实现有着重要的指导意义。读了这本书，再回过去看Windows DDK中一些样本实例的源代码，就更容易理解，理解也可以更深了。

不过，现在实际上在使用的.sys模块还有不少只是传统的Windows NT设备驱动。Windows NT的设备驱动框架可以说是WDM的一个子集，比WDM要简单一些。对于Windows NT设备驱动，Art Baker的“The Windows NT Device Driver Book”是一本很好的参考书。这本书是由 Prentice Hall在1996年出版的。虽然年代已经久远，书的内容却并不显得太陈旧，可以作为WDM那本书的补充，参照阅读。
第四本书是Jeffrey Richter的“Advanced Windows”第3版，微软出版社1997年版。这本书就不仅仅是讲内核了。它让读者对Windows操作系统有个整体上的理解。例如，在另一篇文章中笔者曾提到，Windows在创建子进程时对于已打开文件的遗传与Unix/Linux 在方式上有很大的不同，这本书对此就有很详细的叙述。而这一点正可以说明，不同内核间的有些差别是很难在内核外面得到补偿的。

第五本书是 Gary Nebbett的“Windows NT/2000 Native API Reference”，MTP出版社。这里所说的 “Native API”，实际上就是系统调用。显然，这是一本关于Windows NT系统调用的参考手册。既然微软把系统调用界面藏在黑盒子里面，或者说藏在 Win32 API后面，从来都不公开，那么这本参考手册的价值也就不言而喻了。看一下这本书，就可以知道实现Windows系统调用界面的工作量该有多 大。

作为对这本书的补充，Parasad Dabak等人的“Undocumented Windows NT”，M& T Books，1999年出版，对于Windows NT系统调用的实现也是一本有用的参考书。与前面几本由微软出版的参考书不同的是，这两本书的材料主要是通过逆向工程得来的。有源代码作为根基的著作固然比较权威，根据实验取得的资料也值得重视。

还有一本Sven Schreiber的 “Undocumented Windows 2000 Secrets”，Addison-Wesley，2001年出版，也是一本好书，甚至更好。这本书一边是基于逆向工程介绍Windows内核各方面的内容，也包括设备驱动；另一边还教给读者一些逆向工程的方法，所以对程序的调试很有好处。特别值得一提的是，这本书的附录中实际上还列出了Win2k系统调用的函数跳转表、即函数名与系统调用号的对照，书中还讲述了这个对照表是如何得来的。这可是个宝贵的信息。因为Native API一书中虽然详细介绍了各个具体系统调用的使用方法，却并未提供它们的系统调用号。而若缺了这个信息，我们在实现 Windows系统调用界面的函数跳转表时就得多费许多周折。

Rajeev Nagar的“Windows NT File System Internals”，O’Reilly，1997，虽然主题是“文件系统内幕”，但是实际上对内核的各个方面都有一些介绍，也有一定的参考价值。

## Windows 应用程序开发

《Windows 程序设计》
《Windows 核心编程》

最后，关于 Windows 的技术资料，微软本身的各种 SDK、DDK、以及 MSDN 网站上的资料当然是重要的，但是信息量太大。在笔者看来，微软的资料数量之大正是由于不公开源代码。一件东西，放在透明的玻璃瓶里，自然就不需要作太多的描述；而若封装在一个黑盒子中，描述起来可就费劲了。微软既不肯公开其源码，却又想要别人在此基础上开发各种第三方软件，自然就得对其各种产品作黑盒子描述，“信息爆炸”就不可避免了。许多人见了微软的资料就烦，是因为这些资料只告诉你“其然”而不告诉你“其所以然”。也有许多人很喜欢微软的资料，是因为这些资料就像使用手册，所以“一抓就灵”。也难怪市面上有那么多关于 Windows的各种“宝典”。读微软的资料可以使你成为“很好的”工程师，却不会使你成为科学家。

## 结束语
